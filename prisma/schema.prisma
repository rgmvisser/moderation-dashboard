datasource db {
  provider = "postgres"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["extendedWhereUnique"]
}

enum Status {
  allowed
  flagged
  hidden
}

enum SignInMethod {
  email
  google
  facebook
}

model Tenant {
  id   String @id @default(cuid())
  name String
  slug String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  User          User[]
  Content       Content[]
  Project       Project[]
  Reason        Reason[]
  StatusReasons StatusReasons[]
  Action        Action[]
  Topic         Topic[]

  ModeratorFilters ModeratorFilters[]
  ModeratorRole    ModeratorRole[]
}

enum Role {
  admin
  moderator
}

model ModeratorRole {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId    String
  moderator   Moderator @relation(fields: [moderatorId], references: [id])
  moderatorId String
}

model Moderator {
  id               String            @id @default(cuid())
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  name             String
  email            String            @unique
  avatar           String?
  ModeratorFilters ModeratorFilters?
  Action           Action[]
  roles            ModeratorRole[]
  Authentication   Authentication[]
}

enum CMAuthenticationMethod {
  EmailPassword
}

model Authentication {
  id          String                 @id @default(cuid())
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  provider    CMAuthenticationMethod
  hash        String
  moderator   Moderator              @relation(fields: [moderatorId], references: [id])
  moderatorId String
}

model User {
  id String @id @default(cuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name         String
  signInMethod SignInMethod
  location     String
  status       Status

  contents Content[]
  Action   Action[]
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId String
}

model BacklogMessage {
  id                     String @id @default(cuid())
  millisecondsAfterStart Int
  content                String

  userId    String
  projectId String
  topicId   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    Status
}

model Content {
  id                     String @id @default(cuid())
  millisecondsAfterStart Int
  content                String
  status                 Status

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId  String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  project   Project  @relation(fields: [projectId], references: [id])
  projectId String
  topic     Topic    @relation(fields: [topicId], references: [id])
  topicId   String
  Action    Action[]
}

model Project {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String

  contents Content[]
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId String
}

model Topic {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String

  contents Content[]
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId String
}

model ModeratorFilters {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  projects  String
  topics    String
  statuses  String

  moderator   Moderator @relation(fields: [moderatorId], references: [id], onDelete: Cascade)
  moderatorId String    @unique
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId    String
}

model Reason {
  id            String          @id @default(cuid())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  name          String
  StatusReasons StatusReasons[]
  Action        Action[]
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId      String
}

model StatusReasons {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    Status
  reason    Reason   @relation(fields: [reasonId], references: [id], onDelete: Cascade)
  reasonId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId  String
}

enum ActionType {
  ChangeStatus
}

model Action {
  id        String     @id @default(cuid())
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  info      Json       @default("{}")
  type      ActionType

  tenant            Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId          String
  reason            Reason     @relation(fields: [reasonId], references: [id], onDelete: Cascade)
  reasonId          String
  reasonInformation String?
  takenBy           Moderator? @relation(fields: [takenById], references: [id], onDelete: Cascade)
  takenById         String?

  content   Content? @relation(fields: [contentId], references: [id], onDelete: Cascade)
  contentId String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?
}
